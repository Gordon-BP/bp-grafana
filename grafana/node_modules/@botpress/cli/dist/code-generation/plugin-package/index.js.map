{
  "version": 3,
  "sources": ["../../../src/code-generation/plugin-package/index.ts"],
  "sourcesContent": ["import _ from 'lodash'\nimport * as utils from '../../utils'\nimport * as consts from '../consts'\nimport * as gen from '../generators'\nimport * as mod from '../module'\nimport * as types from '../typings'\nimport { PluginPackageDefinitionModule } from './plugin-package-definition'\n\nclass ImplementationModule extends mod.Module {\n  public constructor(private _implementationCode: string) {\n    super({\n      path: 'implementation.ts',\n      exportName: 'default',\n    })\n  }\n\n  public async getContent(): Promise<string> {\n    const base64Str = Buffer.from(this._implementationCode).toString('base64')\n    const chunks: string[] = _.chunk(base64Str, 80).map((chunk) => chunk.join(''))\n\n    return [\n      //\n      'export default Buffer.from([',\n      ...chunks.map((chunk) => `  \"${chunk}\",`),\n      '].join(\"\"), \"base64\")',\n    ].join('\\n')\n  }\n}\n\nclass LocalPluginModule extends mod.Module {\n  private _implModule: ImplementationModule\n\n  public constructor(private _pkg: Extract<types.PluginInstallablePackage, { source: 'local' }>) {\n    super({\n      path: consts.INDEX_FILE,\n      exportName: consts.DEFAULT_EXPORT_NAME,\n    })\n\n    this._implModule = new ImplementationModule(this._pkg.implementationCode)\n    this.pushDep(this._implModule)\n  }\n\n  public async getContent(): Promise<string> {\n    const implImport = this._implModule.import(this)\n\n    const id = undefined\n    const uri = utils.path.win32.escapeBackslashes(this._pkg.path)\n\n    const definitionImport = utils.path.rmExtension(\n      utils.path.join(this._pkg.path, consts.fromWorkDir.pluginDefinition)\n    )\n\n    const tsId = gen.primitiveToTypescriptValue(id)\n    const tsUri = gen.primitiveToTypescriptValue(uri)\n    const tsName = gen.primitiveToTypescriptValue(this._pkg.name)\n    const tsVersion = gen.primitiveToTypescriptValue(this._pkg.version)\n\n    return [\n      consts.GENERATED_HEADER,\n      'import * as sdk from \"@botpress/sdk\"',\n      '',\n      `import definition from \"${definitionImport}\"`,\n      `import implementation from \"./${implImport}\"`,\n      '',\n      'export default {',\n      '  type: \"plugin\",',\n      `  id: ${tsId},`,\n      `  uri: ${tsUri},`,\n      `  name: ${tsName},`,\n      `  version: ${tsVersion},`,\n      '  definition,',\n      '  implementation,',\n      '} satisfies sdk.PluginPackage',\n    ].join('\\n')\n  }\n}\n\nclass RemotePluginModule extends mod.Module {\n  private _implModule: ImplementationModule\n  private _defModule: PluginPackageDefinitionModule\n\n  public constructor(private _pkg: Extract<types.PluginInstallablePackage, { source: 'remote' }>) {\n    super({\n      path: consts.INDEX_FILE,\n      exportName: consts.DEFAULT_EXPORT_NAME,\n    })\n\n    this._implModule = new ImplementationModule(this._pkg.plugin.code)\n    this.pushDep(this._implModule)\n\n    this._defModule = new PluginPackageDefinitionModule(this._pkg.plugin)\n    this._defModule.unshift('definition')\n    this.pushDep(this._defModule)\n  }\n\n  public async getContent(): Promise<string> {\n    const implImport = this._implModule.import(this)\n    const defImport = this._defModule.import(this)\n\n    const id = this._pkg.plugin.id\n    const uri = undefined\n\n    const tsId = gen.primitiveToTypescriptValue(id)\n    const tsUri = gen.primitiveToTypescriptValue(uri)\n    const tsName = gen.primitiveToTypescriptValue(this._pkg.name)\n    const tsVersion = gen.primitiveToTypescriptValue(this._pkg.version)\n\n    return [\n      consts.GENERATED_HEADER,\n      'import * as sdk from \"@botpress/sdk\"',\n      '',\n      `import definition from \"./${defImport}\"`,\n      `import implementation from \"./${implImport}\"`,\n      '',\n      'export default {',\n      '  type: \"plugin\",',\n      `  id: ${tsId},`,\n      `  uri: ${tsUri},`,\n      `  name: ${tsName},`,\n      `  version: ${tsVersion},`,\n      '  definition,',\n      '  implementation,',\n      '} satisfies sdk.PluginPackage',\n    ].join('\\n')\n  }\n}\n\nexport const generatePluginPackage = async (pkg: types.PluginInstallablePackage): Promise<types.File[]> => {\n  const module = pkg.source === 'local' ? new LocalPluginModule(pkg) : new RemotePluginModule(pkg)\n  return module.flatten()\n}\n"],
  "mappings": "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",
  "names": ["_", "module"]
}
