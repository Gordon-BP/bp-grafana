"use strict";var Ze=Object.create;var F=Object.defineProperty;var Ve=Object.getOwnPropertyDescriptor;var ze=Object.getOwnPropertyNames;var Je=Object.getPrototypeOf,$e=Object.prototype.hasOwnProperty;var M=(n,e)=>{for(var t in e)F(n,t,{get:e[t],enumerable:!0})},K=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ze(e))!$e.call(n,i)&&i!==t&&F(n,i,{get:()=>e[i],enumerable:!(s=Ve(e,i))||s.enumerable});return n},f=(n,e,t)=>(K(n,e,"default"),t&&K(t,e,"default")),ce=(n,e,t)=>(t=n!=null?Ze(Je(n)):{},K(e||!n||!n.__esModule?F(t,"default",{value:n,enumerable:!0}):t,n)),We=n=>K(F({},"__esModule",{value:!0}),n);var y={};M(y,{Bot:()=>z,BotDefinition:()=>V,BotLogger:()=>x,BotSpecificClient:()=>B,Integration:()=>Z,IntegrationDefinition:()=>G,IntegrationLogger:()=>P,IntegrationSpecificClient:()=>k,InterfaceDefinition:()=>J,Plugin:()=>W,PluginDefinition:()=>$,RuntimeError:()=>q.RuntimeError,botIdHeader:()=>O,botUserIdHeader:()=>se,configurationHeader:()=>A,configurationTypeHeader:()=>ae,integrationIdHeader:()=>ie,isApiError:()=>q.isApiError,messages:()=>ne,operationHeader:()=>R,parseBody:()=>v,serve:()=>U,typeHeader:()=>re,webhookIdHeader:()=>oe});module.exports=We(y);var ne={};M(ne,{defaults:()=>et,markdown:()=>Ye});var r={};M(r,{default:()=>te});var le=require("@bpinternal/zui");f(r,require("@bpinternal/zui"));var te=le.z;var m=r.z.string().min(1),pe=r.z.object({text:m}),ue=r.z.object({markdown:m}),de=r.z.object({imageUrl:m}),fe=r.z.object({audioUrl:m}),me=r.z.object({videoUrl:m}),he=r.z.object({fileUrl:m,title:m.optional()}),ye=r.z.object({latitude:r.z.number(),longitude:r.z.number(),address:r.z.string().optional(),title:r.z.string().optional()}),Te=r.z.object({title:m,subtitle:m.optional(),imageUrl:m.optional(),actions:r.z.array(r.z.object({action:r.z.enum(["postback","url","say"]),label:m,value:m}))}),ge=r.z.object({text:m,options:r.z.array(r.z.object({label:m,value:m}))}),qe=r.z.object({items:r.z.array(Te)}),Qe=r.z.union([r.z.object({type:r.z.literal("text"),payload:pe}),r.z.object({type:r.z.literal("markdown"),payload:ue}),r.z.object({type:r.z.literal("image"),payload:de}),r.z.object({type:r.z.literal("audio"),payload:fe}),r.z.object({type:r.z.literal("video"),payload:me}),r.z.object({type:r.z.literal("file"),payload:he}),r.z.object({type:r.z.literal("location"),payload:ye})]),Xe=r.z.object({items:r.z.array(Qe)}),Ye={schema:ue},et={text:{schema:pe},image:{schema:de},audio:{schema:fe},video:{schema:me},file:{schema:he},location:{schema:ye},carousel:{schema:qe},card:{schema:Te},dropdown:{schema:ge},choice:{schema:ge},bloc:{schema:Xe}};var O="x-bot-id",se="x-bot-user-id",ie="x-integration-id",oe="x-webhook-id",ae="x-bp-configuration-type",A="x-bp-configuration",R="x-bp-operation",re="x-bp-type";var be=require("node:http");var H=console;function v(n){if(!n.body)throw new Error("Missing body");return JSON.parse(n.body)}async function U(n,e=8072,t=it){let s=(0,be.createServer)(async(i,c)=>{try{let o=await tt(i);if(o.path==="/health"){c.writeHead(200).end("ok");return}let a=await n(o);c.writeHead(a?.status??200,a?.headers??{}).end(a?.body??"{}")}catch(o){H.error("Error while handling request",{error:o?.message??"Internal error occured"}),c.writeHead(500).end(JSON.stringify({error:o?.message??"Internal error occured"}))}});return s.listen(e,()=>t(e)),s}async function tt(n){let e=await st(n),t={};for(let i=0;i<n.rawHeaders.length;i+=2){let c=n.rawHeaders[i].toLowerCase(),o=n.rawHeaders[i+1];t[c]=o}let s=new URL(n.url??"",n.headers.host?`http://${n.headers.host}`:"http://botpress.cloud");return{body:e,path:s.pathname,query:nt(s.search,"?"),headers:t,method:n.method?.toUpperCase()??"GET"}}function nt(n,e){return n.indexOf(e)===0?n.slice(e.length):n}async function st(n){return new Promise((e,t)=>{if(n.method!=="POST"&&n.method!=="PUT"&&n.method!=="PATCH")return e(void 0);let s="";n.on("data",i=>s+=i.toString()),n.on("error",i=>t(i)),n.on("end",()=>e(s))})}function it(n){H.info(`Listening on port ${n}`)}f(y,r,module.exports);var q=require("@botpress/client");var h={};M(h,{mapValues:()=>at,pairs:()=>ve,values:()=>ot});var ve=n=>Object.entries(n),ot=n=>Object.values(n),at=(n,e)=>Object.fromEntries(ve(n).map(([t,s])=>[t,e(s,t)]));var l={};M(l,{safePush:()=>rt});var rt=(n,...e)=>n?[...n,...e]:[...e];var j=Symbol("schemaName"),Be=n=>n?h.mapValues(n,(t,s)=>({...t,[j]:s})):{},_e=n=>j in n&&n[j]!==void 0,Pe=n=>n[j];var G=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.icon=e.icon,this.readme=e.readme,this.title=e.title,this.identifier=e.identifier,this.description=e.description,this.configuration=e.configuration,this.configurations=e.configurations,this.events=e.events,this.actions=e.actions,this.channels=e.channels,this.states=e.states,this.user=e.user,this.secrets=e.secrets,this.entities=e.entities,this.interfaces=e.interfaces}name;version;title;description;icon;readme;configuration;configurations;events;actions;channels;states;user;secrets;identifier;entities;interfaces;extend(e,t){let s=t(Be(this.entities)),i=h.pairs(s).find(([g,d])=>!_e(d));if(i)throw new Error(`Cannot extend interface "${e.name}" with entity "${i[0]}"; the provided schema is not part of the integration's entities.`);let c=this;c.interfaces??={};let o=h.mapValues(s,g=>({name:Pe(g),schema:g.schema})),a=Object.values(o).map(g=>g.name),p=a.length===0?e.name:`${e.name}<${a.join(",")}>`;return c.interfaces[p]={...e,entities:o},this}};var I=require("@botpress/client");var xe=require("@botpress/client"),N={retries:3,retryCondition:n=>xe.axiosRetry.isNetworkOrIdempotentRequestError(n)||[429,502].includes(n.response?.status??0),retryDelay:n=>n*1e3};var k=class{constructor(e){this._client=e}createConversation=e=>this._client.createConversation(e);getConversation=e=>this._client.getConversation(e);listConversations=e=>this._client.listConversations(e);getOrCreateConversation=e=>this._client.getOrCreateConversation(e);updateConversation=e=>this._client.updateConversation(e);deleteConversation=e=>this._client.deleteConversation(e);listParticipants=e=>this._client.listParticipants(e);addParticipant=e=>this._client.addParticipant(e);getParticipant=e=>this._client.getParticipant(e);removeParticipant=e=>this._client.removeParticipant(e);createEvent=e=>this._client.createEvent(e);getEvent=e=>this._client.getEvent(e);listEvents=e=>this._client.listEvents(e);createMessage=e=>this._client.createMessage(e);getOrCreateMessage=e=>this._client.getOrCreateMessage(e);getMessage=e=>this._client.getMessage(e);updateMessage=e=>this._client.updateMessage(e);listMessages=e=>this._client.listMessages(e);deleteMessage=e=>this._client.deleteMessage(e);createUser=e=>this._client.createUser(e);getUser=e=>this._client.getUser(e);listUsers=e=>this._client.listUsers(e);getOrCreateUser=e=>this._client.getOrCreateUser(e);updateUser=e=>this._client.updateUser(e);deleteUser=e=>this._client.deleteUser(e);getState=e=>this._client.getState(e);setState=e=>this._client.setState(e);getOrSetState=e=>this._client.getOrSetState(e);patchState=e=>this._client.patchState(e);configureIntegration=e=>this._client.configureIntegration(e);uploadFile=e=>this._client.uploadFile(e);upsertFile=e=>this._client.upsertFile(e);deleteFile=e=>this._client.deleteFile(e);listFiles=e=>this._client.listFiles(e);getFile=e=>this._client.getFile(e);updateFileMetadata=e=>this._client.updateFileMetadata(e)};var L=class{_cost=0;get cost(){return this._cost}setCost(e){this._cost=e}toJSON(){return{cost:this.cost}}};var Ie=require("@bpinternal/zui");var ct=Ie.z.enum(["webhook_received","message_created","action_triggered","register","unregister","ping","create_user","create_conversation"]),Ee=n=>{let e=n[O],t=n[se],s=n[ie],i=n[oe],c=n[ae],o=n[A],a=ct.parse(n[R]);if(!e)throw new Error("Missing bot headers");if(!t)throw new Error("Missing bot user headers");if(!s)throw new Error("Missing integration headers");if(!i)throw new Error("Missing webhook headers");if(!o)throw new Error("Missing configuration headers");if(!a)throw new Error("Missing operation headers");return{botId:e,botUserId:t,integrationId:s,webhookId:i,operation:a,configurationType:c??null,configuration:o?JSON.parse(Buffer.from(o,"base64").toString("utf-8")):{}}};var He=ce(require("util")),S=class{defaultOptions;constructor(e){this.defaultOptions=e}info(...e){this._log("info",e)}debug(...e){this._log("debug",e)}warn(...e){this._log("warn",e)}error(...e){this._log("error",e)}_log(e,t){this._getConsoleMethod(e)(this._serializeMessage(t))}_serializeMessage(e){let t=He.default.format(...e);return process.env.BP_LOG_FORMAT==="json"?this.getJsonMessage(t):t}getJsonMessage(e){return JSON.stringify({msg:e,options:this.defaultOptions})}_getConsoleMethod(e){switch(e){case"debug":return console.debug;case"warn":return console.warn;case"error":return console.error;default:return console.info}}};var P=class extends S{constructor(e){super({visibleToBotOwners:!0,...e})}with(e){return new P({...this.defaultOptions,...e})}withUserID(e){return this.with({userID:e})}withConversationID(e){return this.with({conversationID:e})}withVisibleToBotOwners(e){return this.with({visibleToBotOwners:e})}forBot(){return this.withVisibleToBotOwners(!0)}getJsonMessage(e){return JSON.stringify({msg:e,visible_to_bot_owner:this.defaultOptions.visibleToBotOwners,options:this.defaultOptions})}};var Ce=n=>async e=>{let t=Ee(e.headers),s=new I.Client({botId:t.botId,integrationId:t.integrationId,retry:N}),i=new k(s),c=new P,o={ctx:t,req:e,client:i,logger:c,instance:n};try{let a;switch(t.operation){case"webhook_received":a=await gt(o);break;case"register":a=await pt(o);break;case"unregister":a=await ut(o);break;case"message_created":a=await mt(o);break;case"action_triggered":a=await ht(o);break;case"ping":a=await lt(o);break;case"create_user":a=await dt(o);break;case"create_conversation":a=await ft(o);break;default:throw new Error(`Unknown operation ${t.operation}`)}return a?{...a,status:a.status??200}:{status:200}}catch(a){if((0,I.isApiError)(a)){let g=new I.RuntimeError(a.message,a);return c.forBot().error(g.message),{status:g.code,body:JSON.stringify(g.toJSON())}}console.error(a);let p=new I.RuntimeError("An unexpected error occurred in the integration. Bot owners: Check logs for more informations. Integration owners: throw a RuntimeError to return a custom error message instead.");return c.forBot().error(p.message),{status:p.code,body:JSON.stringify(p.toJSON())}}},lt=async n=>{},gt=async({client:n,ctx:e,req:t,logger:s,instance:i})=>{let{req:c}=v(t);return i.webhook({client:n,ctx:e,req:c,logger:s})},pt=async({client:n,ctx:e,req:t,logger:s,instance:i})=>{if(!i.register)return;let{webhookUrl:c}=v(t);await i.register({client:n,ctx:e,webhookUrl:c,logger:s})},ut=async({client:n,ctx:e,req:t,logger:s,instance:i})=>{if(!i.unregister)return;let{webhookUrl:c}=v(t);await i.unregister({ctx:e,webhookUrl:c,client:n,logger:s})},dt=async({client:n,ctx:e,req:t,logger:s,instance:i})=>{if(!i.createUser)return;let{tags:c}=v(t);return await i.createUser({ctx:e,client:n,tags:c,logger:s})},ft=async({client:n,ctx:e,req:t,logger:s,instance:i})=>{if(!i.createConversation)return;let{channel:c,tags:o}=v(t);return await i.createConversation({ctx:e,client:n,channel:c,tags:o,logger:s})},mt=async({ctx:n,req:e,client:t,logger:s,instance:i})=>{let{conversation:c,user:o,type:a,payload:p,message:g}=v(e),d=i.channels[c.channel];if(!d)throw new Error(`Channel ${c.channel} not found`);let T=d.messages[a];if(!T)throw new Error(`Message of type ${a} not found in channel ${c.channel}`);await T({ctx:n,conversation:c,message:g,user:o,type:a,client:t,payload:p,ack:async({tags:Q})=>{await t.updateMessage({id:g.id,tags:Q})},logger:s})},ht=async({req:n,ctx:e,client:t,logger:s,instance:i})=>{let{input:c,type:o}=v(n);if(!o)throw new Error("Missing action type");let a=i.actions[o];if(!a)throw new Error(`Action ${o} not found`);let p=new L,d={output:await a({ctx:e,input:c,client:t,type:o,logger:s,metadata:p}),meta:p.toJSON()};return{body:JSON.stringify(d)}};var Z=class{constructor(e){this.props=e;this.actions=e.actions,this.channels=e.channels,this.register=e.register,this.unregister=e.unregister,this.createUser=e.createUser,this.createConversation=e.createConversation,this.webhook=e.handler}actions;channels;register;unregister;createUser;createConversation;webhook;handler=Ce(this);start=e=>U(this.handler,e)};var V=class{constructor(e){this.props=e;this.integrations=e.integrations,this.plugins=e.plugins,this.user=e.user,this.conversation=e.conversation,this.message=e.message,this.states=e.states,this.configuration=e.configuration,this.events=e.events,this.recurringEvents=e.recurringEvents,this.actions=e.actions}integrations;plugins;user;conversation;message;states;configuration;events;recurringEvents;actions;addIntegration(e,t){let s=this;return s.integrations||(s.integrations={}),s.integrations[e.name]={enabled:t.enabled,...e,configurationType:t.configurationType,configuration:t.configuration},this}addPlugin(e,t){let s=this;return s.plugins||(s.plugins={}),s.plugins[e.name]={...e,configuration:t.configuration,interfaces:t.interfaces},s.user=this._mergeUser(s.user,e.definition.user),s.conversation=this._mergeConversation(s.conversation,e.definition.conversation),s.message=this._mergeMessage(s.message,e.definition.message),s.states=this._mergeStates(s.states,e.definition.states),s.events=this._mergeEvents(s.events,e.definition.events),s.recurringEvents=this._mergeRecurringEvents(s.recurringEvents,e.definition.recurringEvents),s.actions=this._mergeActions(s.actions,e.definition.actions),this}_mergeUser=(e,t)=>({tags:{...e?.tags,...t?.tags}});_mergeConversation=(e,t)=>({tags:{...e?.tags,...t?.tags}});_mergeMessage=(e,t)=>({tags:{...e?.tags,...t?.tags}});_mergeStates=(e,t)=>({...e,...t});_mergeEvents=(e,t)=>({...e,...t});_mergeRecurringEvents=(e,t)=>({...e,...t});_mergeActions=(e,t)=>({...e,...t})};var ke=(n,e)=>{for(let[t,s]of Object.entries(e.actionHandlers))n.actionHandlers[t]=s;for(let[t,s]of Object.entries(e.eventHandlers))s&&(n.eventHandlers[t]=l.safePush(n.eventHandlers[t],...s));for(let[t,s]of Object.entries(e.messageHandlers))s&&(n.messageHandlers[t]=l.safePush(n.messageHandlers[t],...s));for(let[t,s]of Object.entries(e.stateExpiredHandlers))s&&(n.stateExpiredHandlers[t]=l.safePush(n.stateExpiredHandlers[t],...s));for(let[t,s]of Object.entries(e.hookHandlers))for(let[i,c]of Object.entries(s))c&&(n.hookHandlers[t][i]=l.safePush(n.hookHandlers[t][i],...c))};var we=ce(require("@botpress/client"));var x=class extends S{constructor(e){super({...e})}with(e){return new x({...this.defaultOptions,...e})}withUserID(e){return this.with({userID:e})}withConversationID(e){return this.with({conversationID:e})}withWorkflowID(e){return this.with({workflowID:e})}};var B=class{constructor(e,t={before:{},after:{}}){this._client=e;this._hooks=t}getConversation=e=>this._run("getConversation",e);listConversations=e=>this._run("listConversations",e);updateConversation=e=>this._run("updateConversation",e);deleteConversation=e=>this._run("deleteConversation",e);listParticipants=e=>this._run("listParticipants",e);addParticipant=e=>this._run("addParticipant",e);getParticipant=e=>this._run("getParticipant",e);removeParticipant=e=>this._run("removeParticipant",e);getEvent=e=>this._run("getEvent",e);listEvents=e=>this._run("listEvents",e);createMessage=e=>this._run("createMessage",e);getOrCreateMessage=e=>this._run("getOrCreateMessage",e);getMessage=e=>this._run("getMessage",e);updateMessage=e=>this._run("updateMessage",e);listMessages=e=>this._run("listMessages",e);deleteMessage=e=>this._run("deleteMessage",e);getUser=e=>this._run("getUser",e);listUsers=e=>this._run("listUsers",e);updateUser=e=>this._run("updateUser",e);deleteUser=e=>this._run("deleteUser",e);getState=e=>this._run("getState",e);setState=e=>this._run("setState",e);getOrSetState=e=>this._run("getOrSetState",e);patchState=e=>this._run("patchState",e);callAction=e=>this._run("callAction",e);uploadFile=e=>this._run("uploadFile",e);upsertFile=e=>this._run("upsertFile",e);deleteFile=e=>this._run("deleteFile",e);listFiles=e=>this._run("listFiles",e);getFile=e=>this._run("getFile",e);updateFileMetadata=e=>this._run("updateFileMetadata",e);searchFiles=e=>this._run("searchFiles",e);trackAnalytics=e=>this._run("trackAnalytics",e);createConversation=e=>this._client.createConversation(e);getOrCreateConversation=e=>this._client.getOrCreateConversation(e);createUser=e=>this._client.createUser(e);getOrCreateUser=e=>this._client.getOrCreateUser(e);_run=async(e,t)=>{let s=this._hooks.before[e];s&&(t=await s(t));let i=await this._client[e](t),c=this._hooks.after[e];return c&&(i=await c(i)),i}};var Se=require("@bpinternal/zui");var yt=Se.z.enum(["event_received","register","unregister","ping","action_triggered"]),De=n=>{let e=n[O],t=n[A],s=n[re],i=yt.parse(n[R]);if(!e)throw new Error("Missing bot headers");if(!s)throw new Error("Missing type headers");if(!t)throw new Error("Missing configuration headers");if(!i)throw new Error("Missing operation headers");return{botId:e,operation:i,type:s,configuration:t?JSON.parse(Buffer.from(t,"base64").toString("utf-8")):{}}};var _={status:200},Me=n=>async e=>{let t=De(e.headers),s=new x,i=new we.Client({botId:t.botId,retry:N}),c=new B(i,{before:{createMessage:async a=>{let p=n.hookHandlers.before_outgoing_message[a.type]??[],g=n.hookHandlers.before_outgoing_message["*"]??[],d=[...p,...g];for(let T of d)a=(await T({client:new B(i),ctx:t,logger:s,data:a}))?.data??a;return a},callAction:async a=>{let p=n.hookHandlers.before_outgoing_call_action[a.type]??[],g=n.hookHandlers.before_outgoing_call_action["*"]??[],d=[...p,...g];for(let T of d)a=(await T({client:new B(i),ctx:t,logger:s,data:a}))?.data??a;return a}},after:{createMessage:async a=>{let p=n.hookHandlers.after_outgoing_message[a.message.type]??[],g=n.hookHandlers.after_outgoing_message["*"]??[],d=[...p,...g];for(let T of d)a=(await T({client:new B(i),ctx:t,logger:s,data:a}))?.data??a;return a},callAction:async a=>{let p=n.hookHandlers.after_outgoing_call_action[a.output.type]??[],g=n.hookHandlers.after_outgoing_call_action["*"]??[],d=[...p,...g];for(let T of d)a=(await T({client:new B(i),ctx:t,logger:s,data:a}))?.data??a;return a}}}),o={req:e,ctx:t,logger:s,client:c,self:n};switch(t.operation){case"action_triggered":return await _t(o);case"event_received":return await Bt(o);case"register":return await bt(o);case"unregister":return await vt(o);case"ping":return await Tt(o);default:throw new Error(`Unknown operation ${t.operation}`)}},Tt=async({ctx:n})=>(H.info(`Received ${n.operation} operation for bot ${n.botId} of type ${n.type}`),_),bt=async n=>_,vt=async n=>_,Bt=async({ctx:n,logger:e,req:t,client:s,self:i})=>{H.debug(`Received event ${n.type}`);let c=v(t);if(n.type==="message_created"){let b=c.event,u=b.payload.message,X=i.hookHandlers.before_incoming_message[u.type]??[],Y=i.hookHandlers.before_incoming_message["*"]??[],ee=[...X,...Y];for(let D of ee){let w=await D({client:s,ctx:n,logger:e,data:u});if(u=w?.data??u,w?.stop)return _}let Ue={user:b.payload.user,conversation:b.payload.conversation,states:b.payload.states,message:u,event:b},Ke=i.messageHandlers[u.type]??[],Fe=i.messageHandlers["*"]??[],je=[...Ke,...Fe];for(let D of je)await D({...Ue,client:s,ctx:n,logger:e});let Ge=i.hookHandlers.after_incoming_message[u.type]??[],Ne=i.hookHandlers.after_incoming_message["*"]??[],Le=[...Ge,...Ne];for(let D of Le){let w=await D({client:s,ctx:n,data:u,logger:e});if(u=w?.data??u,w?.stop)return _}return _}if(n.type==="state_expired"){let X={state:c.event.payload.state},Y=i.stateExpiredHandlers["*"]??[];for(let ee of Y)await ee({...X,client:s,ctx:n,logger:e});return _}let o=c.event,a=i.hookHandlers.before_incoming_event[o.type]??[],p=i.hookHandlers.before_incoming_event["*"]??[],g=[...a,...p];for(let b of g){let u=await b({client:s,ctx:n,data:o,logger:e});if(o=u?.data??o,u?.stop)return _}let d={event:o},T=i.eventHandlers[o.type]??[],E=i.eventHandlers["*"]??[],Q=[...T,...E];for(let b of Q)await b({...d,client:s,ctx:n,logger:e});let Oe=i.hookHandlers.after_incoming_event[o.type]??[],Ae=i.hookHandlers.after_incoming_event["*"]??[],Re=[...Oe,...Ae];for(let b of Re){let u=await b({client:s,ctx:n,data:o,logger:e});if(o=u?.data??o,u?.stop)return _}return _},_t=async({ctx:n,logger:e,req:t,client:s,self:i})=>{let{input:c,type:o}=v(t);if(!o)throw new Error("Missing action type");let a=i.actionHandlers[o];if(!a)throw new Error(`Action ${o} not found`);let g={output:await a({ctx:n,logger:e,input:c,client:s,type:o})};return{status:200,body:JSON.stringify(g)}};var z=class{constructor(e){this.props=e;this.actionHandlers=e.actions;let t=h.values(e.plugins);for(let s of t)this._use(s)}actionHandlers;messageHandlers={};eventHandlers={};stateExpiredHandlers={};hookHandlers={before_incoming_event:{},before_incoming_message:{},before_outgoing_message:{},before_outgoing_call_action:{},after_incoming_event:{},after_incoming_message:{},after_outgoing_message:{},after_outgoing_call_action:{}};get actions(){return this.actionHandlers}on={message:(e,t)=>{this.messageHandlers[e]=l.safePush(this.messageHandlers[e],t)},event:(e,t)=>{this.eventHandlers[e]=l.safePush(this.eventHandlers[e],t)},stateExpired:(e,t)=>{this.stateExpiredHandlers[e]=l.safePush(this.stateExpiredHandlers[e],t)},beforeIncomingEvent:(e,t)=>{this.hookHandlers.before_incoming_event[e]=l.safePush(this.hookHandlers.before_incoming_event[e],t)},beforeIncomingMessage:(e,t)=>{this.hookHandlers.before_incoming_message[e]=l.safePush(this.hookHandlers.before_incoming_message[e],t)},beforeOutgoingMessage:(e,t)=>{this.hookHandlers.before_outgoing_message[e]=l.safePush(this.hookHandlers.before_outgoing_message[e],t)},beforeOutgoingCallAction:(e,t)=>{this.hookHandlers.before_outgoing_call_action[e]=l.safePush(this.hookHandlers.before_outgoing_call_action[e],t)},afterIncomingEvent:(e,t)=>{this.hookHandlers.after_incoming_event[e]=l.safePush(this.hookHandlers.after_incoming_event[e],t)},afterIncomingMessage:(e,t)=>{this.hookHandlers.after_incoming_message[e]=l.safePush(this.hookHandlers.after_incoming_message[e],t)},afterOutgoingMessage:(e,t)=>{this.hookHandlers.after_outgoing_message[e]=l.safePush(this.hookHandlers.after_outgoing_message[e],t)},afterOutgoingCallAction:(e,t)=>{this.hookHandlers.after_outgoing_call_action[e]=l.safePush(this.hookHandlers.after_outgoing_call_action[e],t)}};_use=e=>{ke(this,e)};handler=Me(this);start=e=>U(this.handler,e)};var J=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.entities=e.entities??{},this.templateName=e.templateName;let t=this._getEntityReference(this.entities),s=e.events===void 0?{}:h.mapValues(e.events,o=>({...o,schema:o.schema(t)})),i=e.actions===void 0?{}:h.mapValues(e.actions,o=>({...o,input:{...o.input,schema:o.input.schema(t)},output:{...o.output,schema:o.output.schema(t)}})),c=e.channels===void 0?{}:h.mapValues(e.channels,o=>({...o,messages:h.mapValues(o.messages,a=>({...a,schema:a.schema(t)}))}));this.events=s,this.actions=i,this.channels=c}name;version;entities;events;actions;channels;templateName;_getEntityReference=e=>{let t={};for(let[s,i]of Object.entries(e)){let c=i.schema._def["x-zui"]?.title,o=i.schema._def.description,a=te.ref(s);c&&a.title(c),o&&a.describe(o),t[s]=a}return t}};var $=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.integrations=e.integrations,this.interfaces=e.interfaces,this.user=e.user,this.conversation=e.conversation,this.message=e.message,this.states=e.states,this.configuration=e.configuration,this.events=e.events,this.recurringEvents=e.recurringEvents,this.actions=e.actions}name;version;integrations;interfaces;user;conversation;message;states;configuration;events;recurringEvents;actions};var W=class{constructor(e){this.props=e;this.actionHandlers=e.actions}_runtimeProps;actionHandlers;messageHandlers={};eventHandlers={};stateExpiredHandlers={};hookHandlers={before_incoming_event:{},before_incoming_message:{},before_outgoing_message:{},before_outgoing_call_action:{},after_incoming_event:{},after_incoming_message:{},after_outgoing_message:{},after_outgoing_call_action:{}};initialize(e){return this._runtimeProps=e,this}get config(){if(!this._runtimeProps)throw new Error("Plugin not correctly initialized. This is likely because you access your plugin config outside of an handler.");return this._runtimeProps}on={message:(e,t)=>{this.messageHandlers[e]=l.safePush(this.messageHandlers[e],t)},event:(e,t)=>{this.eventHandlers[e]=l.safePush(this.eventHandlers[e],t)},stateExpired:(e,t)=>{this.stateExpiredHandlers[e]=l.safePush(this.stateExpiredHandlers[e],t)},beforeIncomingEvent:(e,t)=>{this.hookHandlers.before_incoming_event[e]=l.safePush(this.hookHandlers.before_incoming_event[e],t)},beforeIncomingMessage:(e,t)=>{this.hookHandlers.before_incoming_message[e]=l.safePush(this.hookHandlers.before_incoming_message[e],t)},beforeOutgoingMessage:(e,t)=>{this.hookHandlers.before_outgoing_message[e]=l.safePush(this.hookHandlers.before_outgoing_message[e],t)},beforeOutgoingCallAction:(e,t)=>{this.hookHandlers.before_outgoing_call_action[e]=l.safePush(this.hookHandlers.before_outgoing_call_action[e],t)},afterIncomingEvent:(e,t)=>{this.hookHandlers.after_incoming_event[e]=l.safePush(this.hookHandlers.after_incoming_event[e],t)},afterIncomingMessage:(e,t)=>{this.hookHandlers.after_incoming_message[e]=l.safePush(this.hookHandlers.after_incoming_message[e],t)},afterOutgoingMessage:(e,t)=>{this.hookHandlers.after_outgoing_message[e]=l.safePush(this.hookHandlers.after_outgoing_message[e],t)},afterOutgoingCallAction:(e,t)=>{this.hookHandlers.after_outgoing_call_action[e]=l.safePush(this.hookHandlers.after_outgoing_call_action[e],t)}}};0&&(module.exports={Bot,BotDefinition,BotLogger,BotSpecificClient,Integration,IntegrationDefinition,IntegrationLogger,IntegrationSpecificClient,InterfaceDefinition,Plugin,PluginDefinition,RuntimeError,botIdHeader,botUserIdHeader,configurationHeader,configurationTypeHeader,integrationIdHeader,isApiError,messages,operationHeader,parseBody,serve,typeHeader,webhookIdHeader});
//# sourceMappingURL=index.js.map
